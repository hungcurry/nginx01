# ä¸‰å€‹åˆ†æ”¯ï¼ˆdevã€testã€mainï¼‰
# æª¢æŸ¥ä¸¦å‰µå»º Render æœå‹™ï¼ˆå¦‚æœéœ€è¦ï¼‰
# æ§‹å»ºä¸¦æ¨é€ Docker imageï¼ˆä½¿ç”¨ Git SHA å’Œ latest æ¨™ç±¤ï¼‰
# è§¸ç™¼å°æ‡‰ç’°å¢ƒçš„ Render éƒ¨ç½²ã€‚

name: Deploy to Render

on:
  push:
    branches:
      - dev
      - test
      - main

jobs:
  check-create-service:
    runs-on: ubuntu-latest
    outputs:
      service_exists: ${{ steps.check.outputs.service_exists }}
      service_id: ${{ steps.check.outputs.service_id }}
    steps:
      - name: ğŸ” æª¢æŸ¥ Render æœå‹™æ˜¯å¦å­˜åœ¨
        id: check
        run: |
          SERVICE_NAME="vue-docker-${{ github.ref_name }}"
          EXISTING_SERVICE=$(curl -s -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            "https://api.render.com/v1/services" | jq -r '.[] | select(.serviceName=="'$SERVICE_NAME'") | .id')
          if [[ -n "$EXISTING_SERVICE" ]]; then
            echo "âœ… æœå‹™å·²å­˜åœ¨: $EXISTING_SERVICE"
            echo "service_exists=true" >> $GITHUB_OUTPUT
            echo "service_id=$EXISTING_SERVICE" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœå‹™ä¸å­˜åœ¨ï¼Œå°‡è‡ªå‹•å»ºç«‹..."
            echo "service_exists=false" >> $GITHUB_OUTPUT
            echo "service_id=" >> $GITHUB_OUTPUT
          fi

  create-service:
    needs: check-create-service
    if: needs.check-create-service.outputs.service_exists == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” è¨­å®šå€‹äºº Owner ID
        id: get-owner
        run: |
          OWNER_ID="usr-cstbfrl2ng1s73at7v10"
          echo "ä½¿ç”¨å€‹äºº ownerId: $OWNER_ID (ç¡¬ç·¨ç¢¼)"
          echo "owner_id=$OWNER_ID" >> $GITHUB_OUTPUT
      - name: ğŸ— æ¸¬è©¦çµæ§‹ 1 - ownerId åœ¨ serviceDetails ä¸­ (plan: free)
        run: |
          OWNER_ID="${{ steps.get-owner.outputs.owner_id }}"
          echo "æ¸¬è©¦ 1: ownerId åœ¨ serviceDetails ä¸­, plan: free"
          JSON_PAYLOAD='{"serviceDetails":{"name":"vue-docker-'${{ github.ref_name }}'","ownerId":"'$OWNER_ID'","type":"web_service","env":"docker","repo":"'${{ github.repository }}'","branch":"'${{ github.ref_name }}'","region":"oregon","autoDeploy":false,"plan":"free","docker":{"repo":"hungcurry/vue-docker-dev","tag":"latest"}}}'
          echo "JSON payload:"
          echo "$JSON_PAYLOAD"
          echo "$JSON_PAYLOAD" > request1.json
          curl -v -X POST "https://api.render.com/v1/services" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "@request1.json" > response1.json 2>&1
          echo "API response (çµæ§‹ 1):"
          cat response1.json
      - name: ğŸ— æ¸¬è©¦çµæ§‹ 2 - ownerId åœ¨é ‚å±¤ (plan: free)
        run: |
          OWNER_ID="${{ steps.get-owner.outputs.owner_id }}"
          echo "æ¸¬è©¦ 2: ownerId åœ¨é ‚å±¤, plan: free"
          JSON_PAYLOAD='{"ownerId":"'$OWNER_ID'","serviceDetails":{"name":"vue-docker-'${{ github.ref_name }}'","type":"web_service","env":"docker","repo":"'${{ github.repository }}'","branch":"'${{ github.ref_name }}'","region":"oregon","autoDeploy":false,"plan":"free","docker":{"repo":"hungcurry/vue-docker-dev","tag":"latest"}}}'
          echo "JSON payload:"
          echo "$JSON_PAYLOAD"
          echo "$JSON_PAYLOAD" > request2.json
          curl -v -X POST "https://api.render.com/v1/services" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "@request2.json" > response2.json 2>&1
          echo "API response (çµæ§‹ 2):"
          cat response2.json

  build-dev:
    if: github.ref == 'refs/heads/dev'
    needs: check-create-service
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”½ Checkout Repository
        uses: actions/checkout@v3
      - name: ğŸ” Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
      - name: ğŸ— Build & Push Docker Image (Dev)
        run: |
          docker build -f docker/Dockerfile.dev -t hungcurry/vue-docker-dev:${{ github.sha }} -t hungcurry/vue-docker-dev:latest .
          docker push hungcurry/vue-docker-dev:${{ github.sha }}
          docker push hungcurry/vue-docker-dev:latest

  deploy-dev:
    if: github.ref == 'refs/heads/dev'
    needs: [build-dev, check-create-service]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ è§¸ç™¼ Render éƒ¨ç½² (Dev)
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ needs.check-create-service.outputs.service_id }}/deploys" \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          -H "Accept: application/json" \
          -H "Content-Type: application/json" \
          -d '{}'

  # build-test, deploy-test, build-prod, deploy-prod ç­‰ä¿æŒä¸è®Š  

  build-test:
    if: github.ref == 'refs/heads/test'
    needs: check-create-service
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”½ Checkout Repository
        uses: actions/checkout@v3
      - name: ğŸ” Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
      - name: ğŸ— Build & Push Docker Image (Test)
        run: |
          docker build -f docker/Dockerfile.test -t hungcurry/vue-docker-test:${{ github.sha }} -t hungcurry/vue-docker-test:latest .
          docker push hungcurry/vue-docker-test:${{ github.sha }}
          docker push hungcurry/vue-docker-test:latest

  build-prod:
    if: github.ref == 'refs/heads/main'
    needs: check-create-service
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”½ Checkout Repository
        uses: actions/checkout@v3
      - name: ğŸ” Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
      - name: ğŸ— Build & Push Docker Image (Prod)
        run: |
          docker build -f docker/Dockerfile.prod -t hungcurry/vue-docker-prod:${{ github.sha }} -t hungcurry/vue-docker-prod:latest .
          docker push hungcurry/vue-docker-prod:${{ github.sha }}
          docker push hungcurry/vue-docker-prod:latest

  deploy-test:
    if: github.ref == 'refs/heads/test'
    needs: [build-test, check-create-service]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ è§¸ç™¼ Render éƒ¨ç½² (Test)
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ needs.check-create-service.outputs.service_id }}/deploys" \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          -H "Accept: application/json" \
          -H "Content-Type: application/json" \
          -d '{}'

  deploy-prod:
    if: github.ref == 'refs/heads/main'
    needs: [build-prod, check-create-service]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ è§¸ç™¼ Render éƒ¨ç½² (Prod)
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ needs.check-create-service.outputs.service_id }}/deploys" \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          -H "Accept: application/json" \
          -H "Content-Type: application/json" \
          -d '{}'
