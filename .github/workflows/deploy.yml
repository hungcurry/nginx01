# ä¸‰å€‹åˆ†æ”¯ï¼ˆdevã€testã€mainï¼‰
# æª¢æŸ¥ä¸¦å‰µå»º Render æœå‹™ï¼ˆå¦‚æœéœ€è¦ï¼‰
# æ§‹å»ºä¸¦æ¨é€ Docker imageï¼ˆä½¿ç”¨ Git SHA å’Œ latest æ¨™ç±¤ï¼‰
# è§¸ç™¼å°æ‡‰ç’°å¢ƒçš„ Render éƒ¨ç½²ã€‚

name: Deploy to Render

on:
  push:
    branches:
      - dev
      - test
      - main

jobs:
  check-create-service:
    runs-on: ubuntu-latest
    outputs:
      service_exists: ${{ steps.check.outputs.service_exists }}
      service_id: ${{ steps.check.outputs.service_id }}
    steps:
      - name: ğŸ” æª¢æŸ¥ Render æœå‹™æ˜¯å¦å­˜åœ¨
        id: check
        run: |
          SERVICE_NAME="vue-docker-${{ github.ref_name }}"
          EXISTING_SERVICE=$(curl -s -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            "https://api.render.com/v1/services" | jq -r '.[] | select(.serviceName=="'$SERVICE_NAME'") | .id')

          if [[ -n "$EXISTING_SERVICE" ]]; then
            echo "âœ… æœå‹™å·²å­˜åœ¨: $EXISTING_SERVICE"
            echo "service_exists=true" >> $GITHUB_ENV
            echo "service_id=$EXISTING_SERVICE" >> $GITHUB_ENV
          else
            echo "âš ï¸ æœå‹™ä¸å­˜åœ¨ï¼Œå°‡è‡ªå‹•å»ºç«‹..."
            echo "service_exists=false" >> $GITHUB_ENV
          fi
          
          echo "::set-output name=service_exists::$service_exists"
          echo "::set-output name=service_id::$EXISTING_SERVICE"

  create-service:
    needs: check-create-service
    if: needs.check-create-service.outputs.service_exists == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ— è‡ªå‹•å»ºç«‹ Render æœå‹™
        run: |
          curl -X POST "https://api.render.com/v1/services" \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
            "serviceDetails": {
              "name": "vue-docker-${{ github.ref_name }}",
              "type": "web_service",
              "env": "docker",
              "repo": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}",
              "region": "oregon"
            }
          }'

  build-dev:
    if: github.ref == 'refs/heads/dev'
    needs: check-create-service
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”½ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ” Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: ğŸ— Build & Push Docker Image (Dev)
        run: |
          docker build -f docker/Dockerfile.dev -t hungcurry/vue-docker-dev:${{ github.sha }} -t hungcurry/vue-docker-dev:latest .
          docker push hungcurry/vue-docker-dev:${{ github.sha }}
          docker push hungcurry/vue-docker-dev:latest

  build-test:
    if: github.ref == 'refs/heads/test'
    needs: check-create-service
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”½ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ” Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: ğŸ— Build & Push Docker Image (Test)
        run: |
          docker build -f docker/Dockerfile.test -t hungcurry/vue-docker-test:${{ github.sha }} -t hungcurry/vue-docker-test:latest .
          docker push hungcurry/vue-docker-test:${{ github.sha }}
          docker push hungcurry/vue-docker-test:latest

  build-prod:
    if: github.ref == 'refs/heads/main'
    needs: check-create-service
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”½ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ” Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: ğŸ— Build & Push Docker Image (Prod)
        run: |
          docker build -f docker/Dockerfile.prod -t hungcurry/vue-docker-prod:${{ github.sha }} -t hungcurry/vue-docker-prod:latest .
          docker push hungcurry/vue-docker-prod:${{ github.sha }}
          docker push hungcurry/vue-docker-prod:latest

  deploy-dev:
    if: github.ref == 'refs/heads/dev'
    needs: [build-dev, create-service, check-create-service]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ è§¸ç™¼ Render éƒ¨ç½² (Dev)
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ needs.check-create-service.outputs.service_id }}/deploys" \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          -H "Accept: application/json" \
          -H "Content-Type: application/json" \
          -d '{}'

  deploy-test:
    if: github.ref == 'refs/heads/test'
    needs: [build-test, create-service, check-create-service]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ è§¸ç™¼ Render éƒ¨ç½² (Test)
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ needs.check-create-service.outputs.service_id }}/deploys" \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          -H "Accept: application/json" \
          -H "Content-Type: application/json" \
          -d '{}'

  deploy-prod:
    if: github.ref == 'refs/heads/main'
    needs: [build-prod, create-service, check-create-service]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ è§¸ç™¼ Render éƒ¨ç½² (Prod)
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ needs.check-create-service.outputs.service_id }}/deploys" \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          -H "Accept: application/json" \
          -H "Content-Type: application/json" \
          -d '{}'
